---------------------------------------------------------------------------
-- Rules:
-- ------
-- 1) Any DB objects should be created w/o schema prefix,
--    since this file is executed in a separate schema context.
-- 2) There should be no DROP statements in this script, since
--    all objects created in the default schema will be cleaned-up outside.
---------------------------------------------------------------------------

---------------------------------------------------------------------------
-- Setup:
---------------------------------------------------------------------------

CREATE FUNCTION crf_train_install_test() RETURNS TEXT AS $$
DECLARE
        error FLOAT8;
	result  TEXT;
BEGIN     
	-- Regex table
        CREATE TABLE train_regex(pattern text,name text); 
        INSERT INTO train_regex VALUES
        ('^[A-Z][a-z]+$','InitCapital%'), ('^[A-Z]+$','isAllCapital%'),
        ('^.*[0-9]+.*$','containsDigit%'),('^.+[.]$','endsWithDot%'),
        ('^.+[,]$','endsWithComma%'),     ('^.+er$','endsWithER%'),
        ('^.+est$','endsWithEst%'),       ('^.+ed$','endsWithED%'),
        ('^.+s$','endsWithS%'),           ('^.+ing$','endsWithIng%'),
        ('^.+ly$','endsWithly%'),         ('^.+-.+$','isDashSeparatedWords%'),
        ('^.*@.*$','isEmailId%');
        analyze train_regex;

        CREATE TABLE train_segmenttbl(start_pos integer,doc_id integer,seg_text text,label integer,max_pos integer);
        INSERT INTO train_segmenttbl VALUES
        (0,1,'confidence',11,36),  (1,1,'in',5,36),         (2,1,'the',2,36),         (3,1,'pound',11,36),
        (4,1,'is',31,36),          (5,1,'widely',19,36),    (6,1,'expected',29,36),   (7,1,'to',24,36),
        (8,1,'take',26,36),        (9,1,'another',2,36),    (10,1,'sharp',6,36),      (11,1,'dive',11,36),
        (12,1,'if',5,36),          (13,1,'trade',11,36),    (14,1,'figures',12,36),   (15,1,'for',5,36),
        (16,1,'september',13,36),  (17,1,',',42,36),        (18,1,'due',6,36),        (19,1,'for',5,36),
        (20,1,'release',11,36),    (21,1,'tomorrow',11,36), (22,1,',',42,36),         (23,1,'fail',26,36),
        (24,1,'to',24,36),         (25,1,'show',26,36),     (26,1,'a',2,36),          (27,1,'substantial',6,36),
        (28,1,'improvement',11,36),(29,1,'from',5,36),      (30,1,'july',13,36),      (31,1,'and',0,36),
        (32,1,'august',13,36),     (33,1,'''s',16,36),      (34,1,'near-record',6,36),(35,1,'deficits',12,36),
        (36,1,'.',43,36),          (0,2,'chancellor',13,26),(1,2,'of',5,26),          (2,2,'the',2,26),
        (3,2,'exchequer',13,26),   (4,2,'nigel',13,26),     (5,2,'lawson',13,26),     (6,2,'''s',16,26),
        (7,2,'restated',29,26),    (8,2,'commitment',11,26),(9,2,'to',24,26),         (10,2,'a',2,26),
        (11,2,'firm',11,26),       (12,2,'monetary',6,26),  (13,2,'policy',11,26),    (14,2,'has',31,26),
        (15,2,'helped',29,26),     (16,2,'to',24,26),       (17,2,'prevent',26,26),   (18,2,'a',2,26),
        (19,2,'freefall',11,26),   (20,2,'in',5,26),        (21,2,'sterling',11,26),  (22,2,'over',5,26),
        (23,2,'the',2,26),         (24,2,'past',6,26),      (25,2,'week',11,26),      (26,2,'.',43,26);

        CREATE TABLE train_dictionary(token text,total integer);

        CREATE TABLE train_featuretbl(doc_id integer,f_size FLOAT8,sparse_r FLOAT8[],dense_m FLOAT8[],sparse_m FLOAT8[]);

        CREATE TABLE train_featureset(f_index integer, f_name text, feature integer[]);

        PERFORM MADLIB_SCHEMA.crf_train_fgen('train_segmenttbl', 'train_regex', 'train_dictionary', 'train_featuretbl','train_featureset');

        CREATE TABLE train_crf_feature (id integer,name text,prev_label_id integer,label_id integer,weight float);

        PERFORM MADLIB_SCHEMA.lincrf('train_featuretbl','sparse_r','dense_m','sparse_m','f_size',45, 'train_featureset','train_crf_feature', 20);

        -- Expected feature table
        CREATE TABLE expected_crf_feature(id integer,name text,prev_label integer,label integer,weight float);
	INSERT INTO expected_crf_feature VALUES
	(0,'W_for',-1,5,3.98725801742607),           (1,'R_endsWithIng%',-1,11,1.09481090515543),
	(2,'W_restated',-1,29,1.56553670199044),     (3,'E.',13,42,2.17493422058896),
	(4,'E.',5,2,3.50118889498068),               (5,'E.',24,2,2.93651055374926),
	(6,'W_to',-1,24,5.14502515289159),           (7,'W_chancellor',-1,13,4.24135930086875),
	(8,'W_has',-1,31,2.17790349890217),          (9,'R_endsWithER%',-1,2,2.11294504054538),
	(10,'U',-1,6,2.3732069737735),               (11,'W_,',-1,42,4.2471264124668),
	(12,'S.',-1,13,1.82810940982285),            (13,'U',-1,31,1.57314107273237),
	(14,'U',-1,12,1.3445425711402),              (15,'W_''s',-1,16,2.79453013004211),
	(16,'E.',11,43,1.51333515777666),            (17,'E.',11,5,2.86530567314545),
	(18,'W_exchequer',-1,13,1.85237463860536),   (19,'W_deficits',-1,12,2.59601607603058),
	(20,'R_endsWithly%',-1,19,1.90295633104344), (21,'W_freefall',-1,11,2.47906181302937),
	(22,'W_trade',-1,11,2.00045249210596),       (23,'W_tomorrow',-1,11,3.12924021721703),
	(24,'E.',12,5,2.27984707843581),             (25,'W_helped',-1,29,1.24513716827498),
	(26,'E.',13,16,3.39243336684771),            (27,'W_from',-1,5,2.7980025060185),
	(28,'E.',29,11,2.20369506329517),            (29,'W_show',-1,26,1.24572398486594),
	(30,'W_prevent',-1,26,1.32470245546014),     (31,'S.',-1,11,0.23229251160587),
	(32,'W_fail',-1,26,2.61706872133432),        (33,'E.',11,11,0.398845062565684),
	(34,'W_confidence',-1,11,3.44845170721443),  (35,'W_dive',-1,11,1.31258932019106),
	(36,'E.',31,19,2.49132645397007),            (37,'E.',42,6,2.8165021096734),
	(38,'W_commitment',-1,11,1.90760747547857),  (39,'E.',2,13,1.93910600342153),
	(40,'W_august',-1,13,1.31571419899414),      (41,'E.',11,31,2.36785996566214),
	(42,'W_improvement',-1,11,1.40477239523136), (43,'W_of',-1,5,3.4635968021731),
	(44,'U',-1,2,0.0759363648370593),            (45,'U',-1,29,1.76072003797411),
	(46,'R_endsWithly%',-1,13,1.44108083167916), (47,'E.',2,11,2.70644151711011),
	(48,'W_past',-1,6,2.11775890009432),         (49,'W_monetary',-1,6,4.10022834510886),
	(50,'W_week',-1,11,1.80969177084795),        (51,'E.',12,43,2.10826711375467),
	(52,'W_due',-1,6,3.33206415033704),          (53,'E.',24,26,3.25041042267835),
	(54,'W_in',-1,5,3.19771614261908),           (55,'W_take',-1,26,1.44641837698866),
	(56,'U',-1,13,2.43191772795747),             (57,'W_pound',-1,11,1.56126495834126),
	(58,'W_.',-1,43,3.31378223726556),           (59,'W_firm',-1,11,2.54226152470316),
	(60,'E.',11,24,1.54978662660256),            (61,'E.',11,42,2.19795626841854),
	(62,'E.',5,13,2.54240352022066),             (63,'R_endsWithER%',-1,5,1.30690699137582),
	(64,'W_a',-1,2,3.4389842651606),             (65,'E.',11,12,1.23518206000964),
	(66,'E.',31,29,1.89874885887868),            (67,'W_figures',-1,12,2.67677866493891),
	(68,'R_endsWithS%',-1,16,2.65736360896148),  (69,'E.',5,11,3.05069044773159),
	(70,'E.',0,13,2.30442434441233),             (71,'W_sterling',-1,11,1.09481090515543),
	(72,'E.',6,5,1.86796641177738),              (73,'E.',6,11,3.2728444244942),
	(74,'E.',26,24,1.92345333238786),            (75,'W_lawson',-1,13,1.69108456310458),
	(76,'W_widely',-1,19,1.94440970198157),      (77,'W_september',-1,13,2.52001171802873),
	(78,'E.',42,26,2.828207243862),              (79,'E.',13,13,2.00851354978888),
	(80,'U',-1,26,2.28369253555545),             (81,'W_substantial',-1,6,2.08752727440555),
	(82,'W_nigel',-1,13,3.75964552684739),       (83,'E.',29,24,1.81601036718662),
	(84,'E.',11,6,1.03691930857843),             (85,'R_endsWithED%',-1,29,3.91098037450242),
	(86,'W_policy',-1,11,0.86841633673943),      (87,'E.',26,2,3.35872419449854),
	(88,'R_endsWithS%',-1,31,2.62971889378328),  (89,'E.',2,6,3.10277278363743),
	(90,'W_near-record',-1,6,1.74353253934118),  (91,'R_endsWithS%',-1,12,3.60502531351276),
	(92,'End.',-1,43,3.31378223726556),          (93,'R_isDashSeparatedWords%',-1,6,1.74353253934118),
	(94,'W_another',-1,2,2.24317009915505),      (95,'W_sharp',-1,6,2.17516014478691),
	(96,'E.',13,5,1.53698081893724),             (97,'W_july',-1,13,1.98077678928565),
	(98,'U',-1,19,1.21336685975476),             (99,'U',-1,0,1.39393151164918),
	(100,'U',-1,5,1.26036991380617),             (101,'W_and',-1,0,4.16655514459026),
	(102,'W_if',-1,5,3.36010392064384),          (103,'W_release',-1,11,3.76733343163073),
	(104,'E.',13,0,2.40709662821498),            (105,'E.',6,12,1.87950076480902),
	(106,'E.',19,29,2.08089854221997),           (107,'E.',16,6,1.46157205352295),
	(108,'W_expected',-1,29,1.100306504237),     (109,'W_is',-1,31,1.78818268874887),
	(110,'R_endsWithER%',-1,13,2.81725201712484),(111,'U',-1,11,3.3419440896923),
	(112,'W_the',-1,2,3.93543164110061),         (113,'E.',16,29,1.9301094449202),
	(114,'W_over',-1,5,1.64469918923489);

	SELECT SUM(abs(c1.weight-c2.weight)) INTO error 
        FROM expected_crf_feature c1, train_crf_feature c2
        WHERE c1.name = c2.name AND c1.prev_label = c2.prev_label_id AND c1.label = c2.label_id;

        SELECT INTO result CASE WHEN (error <0.1) THEN 'PASS' ELSE 'FAIL' END;

	IF result = 'FAIL' THEN
	   RAISE EXCEPTION 'Failed install check %', error;
	END IF;

	RETURN result;

END
$$ language plpgsql;

---------------------------------------------------------------------------
-- Test: 
---------------------------------------------------------------------------
SELECT crf_train_install_test();
