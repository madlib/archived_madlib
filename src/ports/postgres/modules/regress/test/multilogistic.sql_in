/* -----------------------------------------------------------------------------
 * Test Multinomial Logistic Regression.
 * -------------------------------------------------------------------------- */

/*
 * The following example is taken from:
 * http://luna.cas.usf.edu/~mbrannic/files/regression/Logistic.html
 * Predicting heart attack. This example is the same as the (binomial) logistic 
 * regression example.
 */
DROP TABLE IF EXISTS patients;
CREATE TABLE patients (
    id INTEGER NOT NULL,
    second_attack INTEGER,
    treatment INTEGER,
    trait_anxiety INTEGER,
    CONSTRAINT pk_patient PRIMARY key (id)
);

INSERT INTO patients(ID, second_attack, treatment, trait_anxiety) VALUES
( 1, 1, 1, 70),
( 2, 1, 1, 80),
( 3, 1, 1, 50),
( 4, 1, 0, 60),
( 5, 1, 0, 40),
( 6, 1, 0, 65),
( 7, 1, 0, 75),
( 8, 1, 0, 80),
( 9, 1, 0, 70),
(10, 1, 0, 60),
(11, 0, 1, 65),
(12, 0, 1, 50),
(13, 0, 1, 45),
(14, 0, 1, 35),
(15, 0, 1, 40),
(16, 0, 1, 50),
(17, 0, 0, 55),
(18, 0, 0, 45),
(19, 0, 0, 50),
(20, 0, 0, 60);

-- The coefficients are from the source above, the other values have been
-- computed with the IRLS optimizer in MADlib
SELECT * FROM mlogregr(
    'patients', 'second_attack', 2 , 'ARRAY[1, treatment, trait_anxiety]',
    20, 'irls',  0.001
);

-- The coefficients are from the source above, the other values have been
-- computed with the IRLS optimizer in MADlib
SELECT assert(
    relative_error(coef, ARRAY[-6.36, -1.02, 0.119]) < 1e-3 AND
    relative_error(log_likelihood, -9.41) < 1e-3 AND
    relative_error(std_err, ARRAY[3.21, 1.17, 0.0550]) < 0.002 AND
    relative_error(z_stats, ARRAY[-1.98, -0.874, 2.17]) < 0.002 AND
    relative_error(p_values, ARRAY[0.0477, 0.382, 0.0304]) < 1e-3 AND
    relative_error(odds_ratios, ARRAY[0.00172, 0.359, 1.13]) < 0.004 AND
    relative_error(condition_no, 106329) < 1e-2,
    'Logistic regression with IRLS optimizer (patients test): Wrong results'
) FROM mlogregr(
    'patients', 'second_attack', 2, 'ARRAY[1, treatment, trait_anxiety]',
    20, 'irls'
);


/*
 * The following example is taken from:
 * http://www.nd.edu/~rwilliam/stats2/l92.pdf
 * Predicting distress in fligjts
 */
CREATE TABLE flights (
    id INTEGER NOT NULL,
    temperature INTEGER,
    date INTEGER,
    distress INTEGER,
    CONSTRAINT pk_patient PRIMARY key (id)
);

INSERT INTO flights(ID, temperature, date, distress) VALUES
(1, 66, 7772, 0),
(2, 70, 7986, 1),
(3, 69, 8116, 0),
(5, 68, 8350, 0),
(6, 67, 8494, 1),
(7, 72, 8569, 0),
(8, 73, 8642, 0),
(9, 70, 8732, 0),
(10, 57, 8799, 1),
(11, 63, 8862, 2),
(12, 70, 9008, 2),
(13, 78, 9044, 0),
(14, 67, 9078, 0),
(15, 53, 9155, 2),
(16, 67, 9233, 2),
(17, 75, 9250, 2),
(18, 70, 9299, 2),
(19, 81, 9341, 1),
(20, 76, 9370, 1),
(21, 79, 9407, 0),
(22, 75, 9434, 2),
(23, 76, 9461, 1),
(24, 58, 9508, 2);


-- The coefficients are from the source above, the other values have been
-- computed with the IRLS optimizer in MADlib
SELECT * FROM mlogregr(
    'flights', 'distress', 3 , 'ARRAY[1, temperature, date]',
    20, 'irls',  0.001
);

