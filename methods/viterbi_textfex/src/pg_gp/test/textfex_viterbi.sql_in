---------------------------------------------------------------------------
-- Rules:
-- ------
-- 1) Any DB objects should be created w/o schema prefix,
--    since this file is executed in a separate schema context.
-- 2) There should be no DROP statements in this script, since
--    all objects created in the default schema will be cleaned-up outside.
---------------------------------------------------------------------------

---------------------------------------------------------------------------
-- Setup:
---------------------------------------------------------------------------

CREATE FUNCTION install_test() RETURNS TEXT AS $$
DECLARE
	result_count  INT;
	result  TEXT;
        temp0 TEXT; 
        temp1 TEXT; 
        temp2 TEXT; 
        temp3 TEXT; 
        temp4 TEXT; 
BEGIN
	-- Documents table
	CREATE TABLE textfex_document (id integer,text text);
        INSERT INTO  textfex_document VALUES
        (1,E'Chancellor  of  the  Exchequer  Nigel  Lawson  ''s  restated  commitment  to  a  firm monetary  policy  has  helped  to  prevent  a  freefall  in  sterling  over  the  past  week  .'),
        (2,E'But  analysts  reckon  underlying  support  for  sterling  has  been  eroded  by  the  chancellor ''s  failure  to  announce  any  new  policy  measures  in  his  Mansion  House  speech  last  Thursday  .');
	analyze textfex_document;

	-- Features table
	CREATE TABLE textfex_feature (id integer,name text,prev_label_id integer,label_id integer,weight float);
        INSERT INTO textfex_feature VALUES
        (60,'E.0',0,12,2.607815743815415),           (96,'W_house',-1,13,3.6333342487137825),     (20,'E.29',29,11,1.5600124715129533),
	(65,'U',-1,30,1.452559873574725),            (63,'R_endsWithS',-1,12,2.473913046238348),  (72,'W_support',-1,11,2.2895172323144894),
	(59,'W_but',-1,0,2.725203469688223),         (17,'U',-1,29,1.693425697873463),            (23,'E.11',11,24,3.3606110066346395),
	(28,'W_firm',-1,11,1.9619447205254092),      (6,'W_the',-1,2,4.203367563910102),          (67,'E.30',30,28,2.854825026257585),
	(83,'W_announce',-1,26,1.9074442270656218),  (53,'W_past',-1,6,2.4011912290135857),       (68,'U',-1,28,0.8602899537153542),
	(56,'W_.',-1,43,5.645859040323563),          (70,'R_endsWithIng',-1,28,1.953539375216373),(7,'E.2',2,13,0.8686206424264802),
	(41,'U',-1,26,1.2230812350282954),           (18,'W_restated',-1,29,1.3667907384413414),  (27,'E.2',2,11,4.035983207379432),
	(35,'W_has',-1,31,2.4794333695904385),       (77,'E.29',29,5,1.8657584825518276),         (76,'W_eroded',-1,29,1.456562458404851),
	(5,'E.5',5,2,3.7540861845275812),            (10,'R_endsWithER',-1,13,2.4571807313097036),(33,'W_policy',-1,11,3.3351854960485765),
	(89,'E.12',12,5,1.9294934320290267),         (62,'W_analysts',-1,12,1.0663957200876484),  (66,'W_reckon',-1,30,2.3996715203005086),
	(88,'W_measures',-1,12,2.2883526709333655),  (22,'W_commitment',-1,11,2.365000671903484), (80,'E.11',11,16,2.5242196471799705),
	(9,'W_exchequer',-1,13,2.7359014450573387),  (52,'E.2',2,6,3.1317693770765573),           (46,'W_in',-1,5,4.569005468959285),
	(25,'E.24',24,2,2.634984876684275),          (4,'W_of',-1,5,2.8853022904929198),          (99,'W_last',-1,6,3.6359136144143562),
	(91,'U',-1,18,1.0451565892329884),           (81,'E.16',16,11,2.416635791303893),         (95,'W_mansion',-1,13,2.3183315830741127),
	(85,'W_any',-1,2,2.7847479325771705),        (36,'R_endsWithS',-1,31,2.1407131198248095), (87,'E.11',11,12,2.1581845386758167),
	(71,'E.28',28,11,2.680721060309714),         (75,'E.29',29,29,1.6687773726752846),        (64,'E.12',12,30,2.3753909439799594),
	(55,'E.11',11,43,2.5149179205008654),        (100,'E.6',6,13,1.762697377388149),          (13,'W_lawson',-1,13,3.2800865176092473),
	(24,'W_to',-1,24,4.547522192651585),         (14,'E.13',13,16,1.8119906734478686),        (51,'R_endsWithER',-1,5,1.5107309846296333),
	(94,'E.18',18,13,2.062880166582969),         (54,'W_week',-1,11,3.1180311941118166),      (42,'W_prevent',-1,26,1.9107742857849523),
	(50,'W_over',-1,5,1.5739011582944251),       (32,'E.6',6,11,2.865906269847471),           (43,'E.26',26,2,3.395918795609039),
	(1,'W_chancellor',-1,13,2.261424567208827),  (8,'U',-1,13,1.7738472500690423),            (0,'S.',-1,13,3.3838730036786195),
	(78,'W_by',-1,5,2.3874921128696283),         (11,'E.13',13,13,2.9430052609336887),        (44,'W_freefall',-1,11,1.8284537186967982),
	(61,'U',-1,12,1.3685407304578037),           (79,'W_chancellor',-1,11,1.8151293730819713),(39,'E.29',29,24,0.6210443588885611),
	(21,'U',-1,11,1.4787064070110214),           (40,'E.24',24,26,3.713834816263397),         (29,'E.11',11,6,2.4713005355872193),
	(37,'E.31',31,29,3.3574362683583217),        (102,'E.13',13,43,2.6953547389864982),       (97,'E.13',13,11,1.9054505928823835),
	(74,'W_been',-1,29,2.1071420243507117),      (49,'R_endsWithIng',-1,11,1.8139956336128529),(98,'W_speech',-1,11,3.587691520449262),
	(45,'E.11',11,5,2.7637938149997083),         (92,'W_his',-1,18,2.428300149010802),        (90,'E.5',5,18,2.193784760171967),
	(48,'W_sterling',-1,11,2.3363726171296424),  (26,'W_a',-1,2,2.66205280374345),            (101,'W_thursday',-1,13,3.8794624946268415),
	(30,'U',-1,6,1.7909960612382005),            (73,'W_for',-1,5,4.067980156480975),         (3,'U',-1,5,1.2394577079417168),
	(31,'W_monetary',-1,6,3.3105699836949194),   (2,'E.13',13,5,2.3761305774890733),          (16,'E.16',16,29,1.9492507580224552),
	(93,'R_endsWithS',-1,18,2.15280577068702),   (34,'E.11',11,31,2.6538929199064336),        (38,'W_helped',-1,29,0.9476532598051483),
	(86,'W_new',-1,6,2.6401678590461723),        (12,'W_nigel',-1,13,2.057493125861811),      (84,'U',-1,2,-0.42146216662804203),
	(19,'R_endsWithED',-1,29,3.7710064566513464),(69,'W_underlying',-1,28,2.1052292635097976),(47,'E.5',5,11,2.482005865540813),
	(82,'W_failure',-1,11,1.6458016331559846),   (58,'U',-1,0,1.7115792838903565),            (57,'S.',-1,0,2.3460688502062736),
	(15,'W_''s',-1,16,5.090147878397093);
        analyze textfex_feature;

	-- Dictionary table
	CREATE TABLE textfex_dictionary (token text,token_id integer,label text,count integer, total integer);
        INSERT INTO textfex_dictionary VALUES
        ('freefall',17,11,1,1),  ('policy',13,11,2,2), ('measures',37,12,1,1), ('commitment',8,11,1,1),
        ('new',36,6,1,1),        ('speech',41,11,1,1), ('''s',6,16,2,2),        ('reckon',26,30,1,1),
        ('underlying',27,28,1,1),('week',22,11,1,1),   ('prevent',16,26,1,1),  ('has',14,31,2,2),
        ('failure',33,11,1,1),   ('restated',7,29,1,1),('announce',34,26,1,1), ('thursday',43,13,1,1),
        ('but',24,0,1,1),        ('lawson',5,13,1,1),  ('last',42,6,1,1),      ('firm',11,11,1,1),
        ('exchequer',3,13,1,1),  ('helped',15,29,1,1), ('sterling',19,11,2,2), ('been',30,29,1,1),
        ('his',38,18,1,1),       ('.',23,43,2,2),      ('the',2,2,3,3),        ('chancellor',0,11,1,2),
        ('chancellor',0,13,1,2), ('in',18,5,2,2),      ('any',35,2,1,1),       ('analysts',25,12,1,1),
        ('of',1,5,1,1),          ('support',28,11,1,1),('by',32,5,1,1),        ('over',20,5,1,1),
        ('for',29,5,1,1),        ('monetary',12,6,1,1),('mansion',39,13,1,1),  ('eroded',31,29,1,1),
        ('house',40,13,1,1),     ('a',10,2,2,2),       ('nigel',4,13,1,1),     ('to',9,24,3,3),
        ('past',21,6,1,1);
	analyze textfex_dictionary;


	-- Regex table
	CREATE TABLE textfex_regex (pattern text,name text);
        INSERT INTO textfex_regex VALUES
        ('^[A-Z][a-z]+$','InitCapital%'), ('^[A-Z]+$','isAllCapital%'), ('^.*[0-9]+.*$','containsDigit%'),
        ('^.+[.]$','endsWithDot%'),       ('^.+[,]$','endsWithComma%'), ('^.+er$','endsWithER%'),
        ('^.+est$','endsWithEst%'),       ('^.+ed$','endsWithED%'),     ('^.+s$','endsWithS%'),
        ('^.+ing$','endsWithIng%'),       ('^.+ly$','endsWithly%'),     ('^.+-.+$','isDashSeparatedWords%'),
        ('^.*@.*$','isEmailId%');
	analyze textfex_regex;

	-- Lexicons table
	CREATE TABLE textfex_lexicon (id integer,filename text,lexicon text);
	analyze textfex_lexicon;

	-- Labels table
	CREATE TABLE textfex_label (id integer,label character varying);
        INSERT INTO textfex_label VALUES
        (0,'CC'),   (1,'CD'),  (2,'DT'),  (3,'EX'),   (4,'FW'),  (5,'IN'),   (6,'JJ'),  (7,'JJR'), (8,'JJS'),
        (9,'LS'),   (10,'MD'), (11,'NN'), (12,'NNS'), (13,'NNP'),(14,'NNPS'),(15,'PDT'),(16,'POS'),(17,'PRP'),
        (18,'PRP$'),(19,'RB'), (20,'RBR'),(21,'RBS'), (22,'RP'), (23,'SYM'), (24,'TO'), (25,'UH'), (26,'VB'),
        (27,'VBD'), (28,'VBG'),(29,'VBN'),(30,'VBP'), (31,'VBZ'),(32,'WDT'), (33,'WP'), (34,'WP$'),(35,'WRB'),
        (36,'$'),   (37,'#'),  (38,''''''), (39,'``'),(40,'('),  (41,')'),   (42,','),  (43,'.'),  (44,':');
	analyze textfex_label;

	-- Segment table
	CREATE TABLE textfex_segmenttbl (start_pos integer,doc_id integer,seg_text text,max_pos integer);
        INSERT INTO textfex_segmenttbl VALUES
        (0,1,'chancellor',26),(1,1,'of',26),       (2,1,'the',26),      (3,1,'exchequer',26), (4,1,'nigel',26),
	(5,1,'lawson',26),    (6,1,'''s',26),      (7,1,'restated',26), (8,1,'commitment',26),(9,1,'to',26),
	(10,1,'a',26),        (11,1,'firm',26),    (12,1,'monetary',26),(13,1,'policy',26),   (14,1,'has',26),
	(15,1,'helped',26),   (16,1,'to',26),      (17,1,'prevent',26), (18,1,'a',26),        (19,1,'freefall',26),
	(20,1,'in',26),       (21,1,'sterling',26),(22,1,'over',26),    (23,1,'the',26),      (24,1,'past',26),
	(25,1,'week',26),     (26,1,'.',26),       (0,2,'but',28),      (1,2,'analysts',28),  (2,2,'reckon',28),
	(3,2,'underlying',28),(4,2,'support',28),  (5,2,'for',28),      (6,2,'sterling',28),  (7,2,'has',28),
	(8,2,'been',28),      (9,2,'eroded',28),   (10,2,'by',28),      (11,2,'the',28),      (12,2,'chancellor',28),
	(13,2,'''s',28),      (14,2,'failure',28), (15,2,'to',28),      (16,2,'announce',28), (17,2,'any',28),
	(18,2,'new',28),      (19,2,'policy',28),  (20,2,'measures',28),(21,2,'in',28),       (22,2,'his',28),
	(23,2,'mansion',28),  (24,2,'house',28),   (25,2,'speech',28),  (26,2,'last',28),     (27,2,'thursday',28),
	(28,2,'.',28);
	analyze textfex_segmenttbl;
           

        -- m&r factor table
        CREATE TABLE viterbi_mtbl (score real[][]);
        CREATE TABLE viterbi_rtbl (seg_text text, label integer, score real);

	-- Segment table
	CREATE TABLE viterbi_segmenttbl(doc_id int, seg_id int, start_pos int, seg_text text);

	-- Labels
	CREATE TABLE viterbi_labels(id integer, label text);
        INSERT INTO viterbi_labels(id, label)
	SELECT id,label
	FROM textfex_label;
        
        -- generate the factors in the training 
	PERFORM MADLIB_SCHEMA.textfex_generatemrtbl(-1,false);

        -- testing a new sentence
        -- insert a new sentence to the textfex_document table
        INSERT INTO textfex_document VALUES
        (3,E'His actions prevent disaster.');
        -- insert a new setence to the segment table
        INSERT INTO textfex_segmenttbl VALUES
        (0,3,'his',4), (1,3,'actions',4), (2,3,'prevent',4), (3,3,'disaster',4), (4,3,'.',4);
          
        -- genearte factors for the new segments not existed in the textfex_segmenttbl
        PERFORM MADLIB_SCHEMA.textfex_generatemrtbl(3,true);

        -- Expected viterbi labeling result
        CREATE TABLE expected_extraction(doc_id integer, start_pos integer, seg_text text, label character varying);
        INSERT INTO expected_extraction VALUES
	(1,0,'chancellor','NNP'),(1,1,'of','IN'),         (1,2,'the','DT'),        (1,3,'exchequer','NNP'), (1,4,'nigel','NNP'),     
	(1,5,'lawson','NNP'),    (1,6,'''s','POS'),       (1,7,'restated','VBN'),  (1,8,'commitment','NN'), (1,9,'to','TO'),         
	(1,10,'a','DT'),         (1,11,'firm','NN'),      (1,12,'monetary','JJ'),  (1,13,'policy','NN'),    (1,14,'has','VBZ'),      
	(1,15,'helped','VBN'),   (1,16,'to','TO'),        (1,17,'prevent','VB'),   (1,18,'a','DT'),         (1,19,'freefall','NN'),  
	(1,20,'in','IN'),        (1,21,'sterling','NN'),  (1,22,'over','IN'),      (1,23,'the','DT'),       (1,24,'past','JJ'),      
	(1,25,'week','NN'),      (1,26,'.','.'),          (2,0,'but','CC'),        (2,1,'analysts','NNS'),  (2,2,'reckon','VBP'),    
	(2,3,'underlying','VBG'),(2,4,'support','NN'),    (2,5,'for','IN'),        (2,6,'sterling','NN'),   (2,7,'has','VBZ'),       
	(2,8,'been','VBN'),      (2,9,'eroded','VBN'),    (2,10,'by','IN'),        (2,11,'the','DT'),       (2,12,'chancellor','NN'),
	(2,13,'''s','POS'),      (2,14,'failure','NN'),   (2,15,'to','TO'),        (2,16,'announce','VB'),  (2,17,'any','DT'),       
	(2,18,'new','JJ'),       (2,19,'policy','NN'),    (2,20,'measures','NNS'), (2,21,'in','IN'),        (2,22,'his','PRP$'),     
	(2,23,'mansion','NNP'),  (2,24,'house','NNP'),    (2,25,'speech','NN'),    (2,26,'last','JJ'),      (2,27,'thursday','NNP'), 
	(2,28,'.','.'),          (3,0,'his','NNP'),      (3,1,'actions','NNP'),   (3,2,'prevent','NNP'),    (3,3,'disaster','NNP'),
        (3,4,'.','.');   
 
        PERFORM MADLIB_SCHEMA.vcrf_label('viterbi_segmenttbl', 'viterbi_mtbl', 'viterbi_rtbl', 'viterbi_labels', 'extraction', 'madlib_installcheck_viterbi_textfex', 'mi');

        -- do a comparaion between the expected result and the viterbi extraction result. It succeed only if the two tables are the same.
	SELECT COUNT(*) INTO result_count FROM ((SELECT * FROM expected_extraction) EXCEPT (SELECT * FROM extraction)) AS U;

        SELECT INTO result CASE WHEN (result_count = 0) THEN 'PASS' ELSE 'FAIL' END;
          
        select label into temp0 from extraction where doc_id=3 and start_pos=0;
        select label into temp1 from extraction where doc_id=3 and start_pos=1;
        select label into temp2 from extraction where doc_id=3 and start_pos=2;
        select label into temp3 from extraction where doc_id=3 and start_pos=3;
        select label into temp4 from extraction where doc_id=3 and start_pos=4;
	IF result = 'FAIL' THEN
	RAISE EXCEPTION 'Failed install check %, %, %, %, %, %', result_count, temp0, temp1, temp2, temp3,temp4;
	END IF;

	RETURN result;

END
$$ language plpgsql;

---------------------------------------------------------------------------
-- Test: 
---------------------------------------------------------------------------
SELECT install_test();
